<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button *ngIf="!selectedPatient" defaultHref="/home"></ion-back-button>
      <ion-button *ngIf="selectedPatient" (click)="backToList()" fill="clear"
        style="--color: white; --color-hover: rgba(255, 255, 255, 0.8);">
        <ion-icon slot="start" name="arrow-back" style="font-size: 24px; margin-right: 4px;"></ion-icon>
        Back
      </ion-button>
    </ion-buttons>
    <ion-title>{{ selectedPatient ? 'Patient Details' : 'View Patients' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Patient List View -->
  <div *ngIf="!selectedPatient" style="max-width: 800px; margin: 0 auto;">
    <ion-searchbar [(ngModel)]="searchTerm" (ionInput)="handleSearch($event)"
      placeholder="Search by name or HMO number">
    </ion-searchbar>

    <!-- Pagination Info -->
    <div *ngIf="filteredPatients.length > 0"
      style="text-align: center; margin: 12px 0; color: var(--ion-color-medium);">
      <p style="font-size: 0.9rem; margin: 0;">
        Showing {{ ((currentPage - 1) * itemsPerPage) + 1 }} - {{ Math.min(currentPage * itemsPerPage,
        filteredPatients.length) }} of {{ filteredPatients.length }} patients
      </p>
    </div>

    <ion-list *ngIf="paginatedPatients.length > 0" style="background: transparent;">
      <ion-card *ngFor="let patient of paginatedPatients" (click)="selectPatient(patient)"
        style="cursor: pointer; margin: 12px 16px; transition: all 0.3s ease;">
        <ion-card-content style="padding: 20px;">
          <div style="display: flex; flex-direction: column; align-items: center; text-align: center; gap: 12px;">

            <!-- Patient Name - Large & Centered -->
            <h2
              style="font-size: 1.5rem; font-weight: 700; color: var(--ion-color-primary); margin: 8px 0 4px 0; letter-spacing: 0.5px;">
              {{ patient.firstName }} {{ patient.lastName }}
            </h2>

            <!-- Patient Info -->
            <div style="display: flex; gap: 16px; align-items: center; justify-content: center; flex-wrap: wrap;">
              <span
                style="display: flex; align-items: center; gap: 4px; color: var(--ion-color-medium); font-size: 0.9rem;">
                <ion-icon name="transgender" style="font-size: 16px;"></ion-icon>
                {{ patient.gender }}
              </span>
              <span
                style="display: flex; align-items: center; gap: 4px; color: var(--ion-color-medium); font-size: 0.9rem;">
                <ion-icon name="calendar" style="font-size: 16px;"></ion-icon>
                Age {{ getAge(patient.birthday) }}
              </span>
            </div>

            <!-- HMO Badge -->
            <div *ngIf="patient.hmoNumber"
              style="background: linear-gradient(135deg, rgba(90, 124, 89, 0.1), rgba(74, 222, 128, 0.1)); padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-top: 8px;">
              <ion-icon name="shield-checkmark" style="color: var(--ion-color-tertiary); font-size: 18px;"></ion-icon>
              <span style="color: var(--ion-color-tertiary); font-weight: 600; font-size: 0.875rem;">
                {{ patient.hmo }} - {{ patient.hmoNumber }}
              </span>
            </div>

            <!-- View Arrow -->
            <ion-icon name="chevron-down"
              style="color: var(--ion-color-primary); font-size: 24px; margin-top: 8px; animation: bounce 2s infinite;"></ion-icon>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Pagination Controls -->
    <div *ngIf="totalPages > 1"
      style="display: flex; justify-content: center; align-items: center; gap: 8px; margin: 24px 16px; flex-wrap: wrap;">
      <ion-button fill="outline" size="small" (click)="previousPage()" [disabled]="currentPage === 1">
        <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>

      <div style="display: flex; gap: 4px; flex-wrap: wrap;">
        <ion-button *ngFor="let page of pageNumbers" [fill]="currentPage === page ? 'solid' : 'outline'" size="small"
          (click)="goToPage(page)" [color]="currentPage === page ? 'primary' : 'medium'" style="min-width: 40px;">
          {{ page }}
        </ion-button>
      </div>

      <ion-button fill="outline" size="small" (click)="nextPage()" [disabled]="currentPage === totalPages">
        <ion-icon slot="icon-only" name="chevron-forward"></ion-icon>
      </ion-button>
    </div>

    <ion-text *ngIf="filteredPatients.length === 0" class="ion-text-center">
      <div style="text-align: center; padding: 60px 20px;">
        <ion-icon name="people-outline"
          style="font-size: 80px; color: var(--ion-color-medium); opacity: 0.5;"></ion-icon>
        <p style="color: var(--ion-color-medium); margin-top: 16px; font-size: 1.1rem;">No patients found</p>
      </div>
    </ion-text>
  </div>

  <!-- Patient Details and Visits View -->
  <div *ngIf="selectedPatient" style="max-width: 1000px; margin: 0 auto;">
    <!-- Patient Info Card -->
    <ion-card style="margin-top: 0;">
      <ion-card-header
        style="background: linear-gradient(135deg, #1a3d1a, #2d5a2e); color: white; border-bottom: none;">
        <div style="display: flex; align-items: center; gap: 16px;">

          <div>
            <ion-card-title style="color: white; font-size: 1.5rem; margin-bottom: 4px;">
              {{ selectedPatient.firstName }} {{ selectedPatient.lastName }}
            </ion-card-title>
            <p style="margin: 0; opacity: 0.9;">{{ selectedPatient.gender }} • Age {{ getAge(selectedPatient.birthday)
              }}</p>
          </div>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="info-row">
          <strong>Birthday</strong>
          <span>{{ selectedPatient.birthday }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.contactNumber">
          <strong>Contact Number</strong>
          <span>{{ selectedPatient.contactNumber }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.occupation">
          <strong>Occupation</strong>
          <span>{{ selectedPatient.occupation }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.company">
          <strong>Company</strong>
          <span>{{ selectedPatient.company }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.hmo">
          <strong>HMO Provider</strong>
          <span>{{ selectedPatient.hmo }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.hmoNumber">
          <strong>HMO Number</strong>
          <span>{{ selectedPatient.hmoNumber }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.validId">
          <strong>Valid ID</strong>
          <span>{{ selectedPatient.validId }}</span>
        </div>
        <div class="info-row" *ngIf="selectedPatient.idNumber">
          <strong>ID Number</strong>
          <span>{{ selectedPatient.idNumber }}</span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
          <ion-button expand="block" (click)="editPatient(selectedPatient)" color="primary" fill="solid">
            <ion-icon slot="start" name="create"></ion-icon>
            Edit
          </ion-button>
          <ion-button expand="block" (click)="deletePatient(selectedPatient)" color="danger" fill="outline">
            <ion-icon slot="start" name="trash"></ion-icon>
            Delete
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Visit History Section -->
    <div style="margin-top: 32px;">
      <h2 style="padding: 0 16px; display: flex; align-items: center; gap: 8px;">
        <ion-icon name="calendar" style="color: var(--ion-color-primary);"></ion-icon>
        Visit History
      </h2>

      <ion-card *ngFor="let visit of visits" style="border-left: 4px solid var(--ion-color-primary);">
        <ion-card-header>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <ion-card-title style="font-size: 1rem;">{{ visit.dateOfVisit | date:'medium' }}</ion-card-title>
            <span [ngClass]="visit.balance > 0 ? 'badge badge-warning' : 'badge badge-success'">
              {{ visit.balance > 0 ? 'Pending' : 'Paid' }}
            </span>
          </div>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <strong>Procedure</strong>
            <span>{{ visit.procedureDone }}</span>
          </div>
          <div class="info-row" *ngIf="visit.comments">
            <strong>Comments</strong>
            <span>{{ visit.comments }}</span>
          </div>
          <div class="info-row">
            <strong>Payment Mode</strong>
            <span>{{ visit.modeOfPayment }}</span>
          </div>
          <div style="background: var(--ion-color-light); padding: 16px; border-radius: 8px; margin: 16px 0;">
            <div class="info-row" style="border: none;">
              <strong>Total Cost</strong>
              <span style="font-weight: 600;">₱{{ visit.totalCost | number:'1.2-2' }}</span>
            </div>
            <div class="info-row" style="border: none;">
              <strong>Total Paid</strong>
              <span style="font-weight: 600; color: var(--ion-color-success);">₱{{ visit.totalPaid | number:'1.2-2'
                }}</span>
            </div>
            <div class="info-row" style="border: none;">
              <strong>Balance</strong>
              <span style="font-weight: 700; font-size: 1.1rem;"
                [style.color]="visit.balance > 0 ? 'var(--ion-color-danger)' : 'var(--ion-color-success)'">
                ₱{{ visit.balance | number:'1.2-2' }}
              </span>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
            <ion-button expand="block" fill="outline" (click)="viewPayments(visit)" size="small">
              <ion-icon slot="start" name="wallet"></ion-icon>
              Payments
            </ion-button>
            <ion-button expand="block" (click)="openPaymentForm(visit)" size="small" *ngIf="visit.balance > 0"
              color="success">
              <ion-icon slot="start" name="add-circle"></ion-icon>
              Add Payment
            </ion-button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
            <ion-button expand="block" fill="outline" (click)="openEditVisit(visit)" size="small" color="warning">
              <ion-icon slot="start" name="create"></ion-icon>
              Edit
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="deleteVisit(visit)" size="small" color="danger">
              <ion-icon slot="start" name="trash"></ion-icon>
              Delete
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-text *ngIf="visits.length === 0" class="ion-text-center">
        <div style="text-align: center; padding: 60px 20px;">
          <ion-icon name="calendar-outline"
            style="font-size: 80px; color: var(--ion-color-medium); opacity: 0.5;"></ion-icon>
          <p style="color: var(--ion-color-medium); margin-top: 16px; font-size: 1.1rem;">No visit records found</p>
        </div>
      </ion-text>
    </div>
  </div>

  <!-- Payment History Modal -->
  <ion-modal [isOpen]="selectedVisit !== null && !showPaymentForm" (didDismiss)="closePayments()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Payment History</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closePayments()">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedVisit">
          <h3>{{ selectedVisit.procedureDone }}</h3>
          <p><strong>Total Cost:</strong> ₱{{ selectedVisit.totalCost | number:'1.2-2' }}</p>
          <p><strong>Total Paid:</strong> ₱{{ selectedVisit.totalPaid | number:'1.2-2' }}</p>
          <p><strong>Remaining Balance:</strong>
            <ion-text [color]="selectedVisit.balance > 0 ? 'danger' : 'success'">
              ₱{{ selectedVisit.balance | number:'1.2-2' }}
            </ion-text>
          </p>

          <h4 class="ion-margin-top">Payments</h4>
          <ion-card *ngFor="let payment of payments">
            <ion-card-content>
              <p><strong>Date:</strong> {{ payment.paymentDate | date:'medium' }}</p>
              <p><strong>Amount:</strong> ₱{{ payment.amount | number:'1.2-2' }}</p>
              <p><strong>Method:</strong> {{ payment.paymentMethod }}</p>
              <p *ngIf="payment.notes"><strong>Notes:</strong> {{ payment.notes }}</p>

              <ion-button expand="block" fill="outline" (click)="openEditPayment(payment)" size="small" color="warning">
                Edit Payment
              </ion-button>
              <ion-button expand="block" fill="outline" (click)="deletePayment(payment)" size="small" color="danger">
                Delete Payment
              </ion-button>
            </ion-card-content>
          </ion-card>

          <ion-text *ngIf="payments.length === 0" class="ion-text-center">
            <p>No payments recorded yet</p>
          </ion-text>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Add Payment Modal -->
  <ion-modal [isOpen]="showPaymentForm" (didDismiss)="cancelPayment()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add Payment</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cancelPayment()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedVisit">
          <p><strong>Procedure:</strong> {{ selectedVisit.procedureDone }}</p>
          <p><strong>Remaining Balance:</strong> ₱{{ selectedVisit.balance | number:'1.2-2' }}</p>

          <ion-item>
            <ion-label position="stacked">Payment Amount (₱) *</ion-label>
            <ion-input type="number" [(ngModel)]="newPayment.amount" name="amount" placeholder="0.00" min="0"
              step="0.01" [max]="selectedVisit.balance">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Payment Date *</ion-label>
            <ion-input type="datetime-local" [(ngModel)]="newPayment.paymentDate" name="paymentDate">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Payment Method *</ion-label>
            <ion-select [(ngModel)]="newPayment.paymentMethod" name="paymentMethod">
              <ion-select-option value="Cash">Cash</ion-select-option>
              <ion-select-option value="Credit Card">Credit Card</ion-select-option>
              <ion-select-option value="Debit Card">Debit Card</ion-select-option>
              <ion-select-option value="GCash">GCash</ion-select-option>
              <ion-select-option value="PayMaya">PayMaya</ion-select-option>
              <ion-select-option value="Bank Transfer">Bank Transfer</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Notes</ion-label>
            <ion-textarea [(ngModel)]="newPayment.notes" name="notes" rows="3" placeholder="Optional payment notes">
            </ion-textarea>
          </ion-item>

          <ion-button expand="block" (click)="addPayment()" class="ion-margin-top">
            Add Payment
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Edit Visit Modal -->
  <ion-modal [isOpen]="showEditVisitForm" (didDismiss)="cancelEditVisit()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Edit Visit</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cancelEditVisit()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="editingVisit">
          <!-- Procedure -->
          <ion-item>
            <ion-label position="stacked">Procedure *</ion-label>
            <ion-select [(ngModel)]="editingVisit.procedureDone" name="procedureDone" placeholder="Select procedure">
              <ion-select-option *ngFor="let procedure of procedures" [value]="procedure">
                {{ procedure }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Date of Visit -->
          <ion-item>
            <ion-label position="stacked">Date of Visit *</ion-label>
            <ion-input type="datetime-local" [(ngModel)]="editingVisit.dateOfVisit" name="dateOfVisit" required>
            </ion-input>
          </ion-item>

          <!-- Mode of Payment -->
          <ion-item>
            <ion-label position="stacked">Mode of Payment *</ion-label>
            <ion-select [(ngModel)]="editingVisit.modeOfPayment" name="modeOfPayment" placeholder="Select payment mode">
              <ion-select-option *ngFor="let mode of paymentModes" [value]="mode">
                {{ mode }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Total Cost -->
          <ion-item>
            <ion-label position="stacked">Total Cost (₱) *</ion-label>
            <ion-input type="number" [(ngModel)]="editingVisit.totalCost" name="totalCost" placeholder="0.00" min="0"
              step="0.01">
            </ion-input>
          </ion-item>

          <!-- Total Paid (Read-only, managed by payments) -->
          <ion-item>
            <ion-label position="stacked">Total Paid (₱)</ion-label>
            <ion-input type="number" [(ngModel)]="editingVisit.totalPaid" name="totalPaid" placeholder="0.00" readonly>
            </ion-input>
          </ion-item>

          <!-- Comments -->
          <ion-item>
            <ion-label position="stacked">Comments</ion-label>
            <ion-textarea [(ngModel)]="editingVisit.comments" name="comments" rows="4"
              placeholder="Additional notes...">
            </ion-textarea>
          </ion-item>

          <ion-text color="medium" class="ion-padding">
            <p><small>Note: Balance will be automatically recalculated. To modify payments, use the payment management
                features.</small></p>
          </ion-text>

          <ion-button expand="block" (click)="updateVisit()" class="ion-margin-top" color="primary">
            Update Visit
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Edit Payment Modal -->
  <ion-modal [isOpen]="showEditPaymentForm" (didDismiss)="cancelEditPayment()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Edit Payment</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cancelEditPayment()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="editingPayment">
          <ion-item>
            <ion-label position="stacked">Payment Amount (₱) *</ion-label>
            <ion-input type="number" [(ngModel)]="editingPayment.amount" name="amount" placeholder="0.00" min="0"
              step="0.01">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Payment Date *</ion-label>
            <ion-input type="datetime-local" [(ngModel)]="editingPayment.paymentDate" name="paymentDate">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Payment Method *</ion-label>
            <ion-select [(ngModel)]="editingPayment.paymentMethod" name="paymentMethod">
              <ion-select-option value="Cash">Cash</ion-select-option>
              <ion-select-option value="Credit Card">Credit Card</ion-select-option>
              <ion-select-option value="Debit Card">Debit Card</ion-select-option>
              <ion-select-option value="GCash">GCash</ion-select-option>
              <ion-select-option value="PayMaya">PayMaya</ion-select-option>
              <ion-select-option value="Bank Transfer">Bank Transfer</ion-select-option>
              <ion-select-option value="Down Payment">Down Payment</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Notes</ion-label>
            <ion-textarea [(ngModel)]="editingPayment.notes" name="notes" rows="3" placeholder="Optional payment notes">
            </ion-textarea>
          </ion-item>

          <ion-text color="medium" class="ion-padding">
            <p><small>Note: Visit balance will be automatically recalculated after updating the payment.</small></p>
          </ion-text>

          <ion-button expand="block" (click)="updatePayment()" class="ion-margin-top" color="primary">
            Update Payment
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>